<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI对话助手</title>
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            color: #333;
            font-family: "Microsoft YaHei", "微软雅黑", sans-serif;
        }

        h1 {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 20px;
            color: #333;
        }

        .tip {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>AI对话助手</h1>
    <div class="tip">请点击右侧紫色悬浮窗进行对话</div>

    <script src="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.10/libs/cn/index.js"></script>
    <script>
    (function() {
        // 配置参数
        const COZE_CONFIG = {
            botId: '7606765422780350499',
            appId: '1180724707390',
            publicKey: 'J2bq1BAN_DqlJbhpzXps5GkY8i37wH2pECPpavTtbLY',
            privateKey: `-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDcwayz2Ym6Ad0Y
SEd01so6i698CH/pIY/LwhGsWTdxjttjlmgtRw9c1gww+21LHj5FdGGvz1HvuJm1
t/NwHelF9EthkQpXrcYUkTp22jCPXkjRGVHotkRRdQX4yBuD0JtRqCRfV3RliFhs
FHHc+7PueXWOgcfKiJnw/QcD5Ydux20H+SXjdLQpbIQ6XTiSX7yspNrYqreezGPj
J6Zz8XUVc553qGpyvziKNJsCN+7L+RbcwdJgGoTQisBC0grTJRYdRTI8l4oTlSLW
QC4asSLKQIF5+Kzr86Uox6DWfGBGl6oemIVdbVCfe4cI2NkSVmTCYeDo3WcERLSe
dDtrz2LJAgMBAAECggEAAv7jJ72ipNI0Ud6z5DNV+IgUuuDSpjM9DvgfN/DYqRiA
hFAc3HXDu5rGp5OB3tcWOT25uvexQPOHAnRF6sDn0s8x3AJqhYNngLfydyfBfkXl
RGZ3j2o0cHaKEjTaSrugn/G2108J1qbhrEsgEG5J+XPPKJPnm36nDXd235KpzShZ
MAjVvj5DyOiglU/WV0ZYzQeVpq7jREA0jQiOCIrZd67wiXkEPo00WqdcDhDyOqll
2b+0h94IMmh/68+KrlSXHPUS5GgEgVJV6Xx3EeMBW6M7N4D8kParjLXsne8Libo6
fPfkBqHIH8k087KDfRZLX9mabFK6ue2yMjlv1mGYAQKBgQDu4NbMj865n+JotdNV
2Q7Nkm7O8ShqTJFi1Ze0dwIvYCBwmLPWY2n/XpN7mlMKFyR4XhURM5oCEY4bICm1
qH2VkMzpRmiJwVoJVzLlq6m/dPCCIbCqVWVpYQ7EXAY6eBzfK8EZ49L8lJ/t+N8k
9GOvwqRoUKWxBpMD8fqZdXMuwQKBgQDslFIycZVGYqf/tYuFVI95EagIkJz9vLKF
fnemciA0ebesaK3Y4sclQNI87rTVFUYUL4vbx5cjDRVOTi63RDIGb6FlUjpAzJ2T
NvqzORUJ6a01cSuWj3upuj+UXQFuH7joWWatiA0PqDhEXUZQ01wfFJFySHAFP/io
ovxNMXA+CQKBgDUtDgP5m15NDjybBVGeASKYD1y36HRJWS/0NlIxD+Z18qK+C4KV
HNqBNjmUsBmV70NwRiZPI2CEgerd7QsIV/R8iHEBgHHx/dYIeEcSQLZjFMsTLt2s
JugfeAcUKTrI1DyF4/WcdrJNb5CtDxeN48cTgD/MfCX9ParqKgwRTjPBAoGBAJkT
e4ACOGlbioKNUGKMDW1z/DrWf446m3R/GSJMtAPgQfU/okU0r1CueZpNhhpd8oM7
JI6nvWZDn+aT9exFJu09K7wokWK+QrMvntV6eN96IMX0nRSFcKmoxlzUNQmxYu6M
ckCUSIc5/HZXuBiyOeguYdIFht4Ov3E2THQSKiMpAoGBAJBuvCBfM2jBeYsvrYkL
rdy9t2izVjYzpoyHKA0aHcmYh5hIgeN8J+BOvg/IIXMWi84/wp25MoIKsJ6eeyDv
eyO69S5eOmTFtkEJXugNANL0Wr6Q/195i/tlabaU33rWgqr+rKck1UJFNRhOBL4s
VqMiUyND0NLV8S1ehiE8Tdmb
-----END PRIVATE KEY-----`
        };

        // 加载JWT库
        function loadJwtLibrary() {
            return new Promise((resolve, reject) => {
                if (window.KJUR && window.KJUR.jws && window.KJUR.jws.JWS) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/8.0.20/jsrsasign-all-min.js';
                script.crossOrigin = 'anonymous';
                script.onload = () => {
                    if (window.KJUR && window.KJUR.jws && window.KJUR.jws.JWS) {
                        resolve();
                    } else {
                        reject(new Error('JWT库加载但未正确初始化'));
                    }
                };
                script.onerror = () => reject(new Error('JWT库加载失败'));
                document.head.appendChild(script);
            });
        }

        // 生成JWT
        function generateCozeJwt(userUid) {
            const header = {
                alg: 'RS256',
                typ: 'JWT',
                kid: COZE_CONFIG.publicKey
            };
            const currentTime = Math.floor(Date.now() / 1000);
            const payload = {
                iss: COZE_CONFIG.appId,
                aud: "api.coze.cn",
                jti: Math.random().toString(36).substr(2, 32) + Date.now(),
                iat: currentTime,
                exp: currentTime + 3600,
                session_name: userUid
            };
            return window.KJUR.jws.JWS.sign(
                header.alg,
                JSON.stringify(header),
                JSON.stringify(payload),
                COZE_CONFIG.privateKey
            );
        }

        // 获取用户唯一标识
        function getUserUid() {
            let visitorId = localStorage.getItem('coze_visitor_id');
            if (!visitorId) {
                visitorId = `visitor_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('coze_visitor_id', visitorId);
            }
            return visitorId;
        }

        // 初始化Coze聊天
        async function initCozeChat() {
            try {
                const userUid = getUserUid();
                const jwtToken = generateCozeJwt(userUid);

                const response = await fetch("https://api.coze.cn/api/permission/oauth2/token", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({
                        grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                        duration_seconds: 900
                    })
                });

                if (!response.ok) {
                    throw new Error(`获取token失败: ${response.status}`);
                }

                const data = await response.json();

                new CozeWebSDK.WebChatClient({
                    config: {
                        bot_id: COZE_CONFIG.botId,
                        isframe: false
                    },
                    componentProps: {
                        title: 'AI对话助手'
                    },
                    auth: {
                        type: 'token',
                        token: data.access_token,
                        onRefreshToken: () => data.access_token
                    }
                });

                console.log('Coze聊天已初始化，用户ID:', userUid);
            } catch (error) {
                console.error('初始化失败:', error.message);
            }
        }

        // 初始化流程
        async function init() {
            try {
                await loadJwtLibrary();
                initCozeChat();
            } catch (error) {
                console.error('初始化失败:', error.message);
            }
        }

        if (document.readyState === 'complete') {
            init();
        } else {
            window.addEventListener('load', init);
        }
    })();
    </script>
</body>
</html>
